name: Free-RDP-PreReserved

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download LocalXpose CLI
        shell: powershell
        run: |
          $zip = "loclx.zip"
          Invoke-WebRequest -Uri "https://api.localxpose.io/api/downloads/loclx-windows-amd64.zip" -OutFile $zip -UseBasicParsing
          Expand-Archive -Path $zip -DestinationPath "." -Force

          # Ensure correct binary name
          if (Test-Path ".\localxpose.exe") {
              if (-not (Test-Path ".\loclx.exe")) {
                  Copy-Item -Path ".\localxpose.exe" -Destination ".\loclx.exe" -Force
                  Write-Host "Copied localxpose.exe -> loclx.exe"
              } else {
                  Write-Host "loclx.exe already exists, skipping copy."
              }
          }

      - name: Enable RDP & Firewall
        shell: powershell
        run: |
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Write-Host "✅ RDP enabled and firewall configured."

      - name: Start TCP Tunnel for RDP (Pre-reserved endpoint)
        shell: powershell
        env:
          LOCLX_TOKEN: ${{ secrets.LOCLX_TOKEN }}
        run: |
          if (-not $Env:LOCLX_TOKEN -or $Env:LOCLX_TOKEN.Trim() -eq "") {
            Write-Error "LOCLX_TOKEN secret is missing."
            exit 1
          }

          # Replace these with your reserved endpoint info
          $region = "us"                  # Region of reserved endpoint
          $publicPort = 4455              # Port you reserved on dashboard
          $localPort = 3389

          Write-Host "Starting TCP tunnel: local $localPort -> public $region.loclx.io:$publicPort"

          # Use authtoken if supported
          try {
            & .\loclx.exe authtoken $Env:LOCLX_TOKEN
            Write-Host "✅ Authenticated using token."
          } catch {
            Write-Warning "Authtoken login failed or not supported, make sure endpoint is pre-reserved."
          }

          # Start tunnel using reserved port
          $args = "tunnel","tcp","--to","127.0.0.1:$localPort","--port",$publicPort,"--region",$region
          $proc = Start-Process -FilePath ".\loclx.exe" -ArgumentList $args -WindowStyle Hidden -PassThru
          Start-Sleep -Seconds 6

          Write-Host "🌐 Public RDP address: $region.loclx.io:$publicPort"
          Write-Host "LocalXpose process id: $($proc.Id)"

          # Optional: list tunnels
          $tunnels = & .\loclx.exe tunnel list 2>&1
          Write-Host "Tunnel list output:"
          $tunnels | ForEach-Object { Write-Host $_ }

      - name: Keep Session Alive
        shell: cmd
        run: ping -t 127.0.0.1 >nul
